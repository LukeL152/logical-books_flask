
{% extends "base.html" %}
{% block content %}
    <h1 class="mb-4">Journal</h1>

    <!-- Filter Form -->
    <form action="{{ url_for('journal') }}" method="post" class="mb-4 p-3 border rounded">
        <div class="row g-3 align-items-end">
            <div class="col-md-2">
                <label for="start_date" class="form-label">Start Date</label>
                <input type="date" id="start_date" name="start_date" class="form-control" value="{{ filters.start_date }}">
            </div>
            <div class="col-md-2">
                <label for="end_date" class="form-label">End Date</label>
                <input type="date" id="end_date" name="end_date" class="form-control" value="{{ filters.end_date }}">
            </div>
            <div class="col-md-3">
                <label for="description" class="form-label">Description</label>
                <input type="text" id="description" name="description" class="form-control" value="{{ filters.description }}">
            </div>
            <div class="col-md-2">
                <label for="account_id" class="form-label">Account</label>
                <select id="account_id" name="account_id" class="form-select">
                    <option value="">All</option>
                    {% for account in accounts %}
                    <option value="{{ account.id }}" {% if filters.account_id == account.id|string %}selected{% endif %}>{{ account.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="category" class="form-label">Category</label>
                <input type="text" id="category" name="category" class="form-control" value="{{ filters.category }}">
            </div>
            <div class="col-md-2">
                <label for="transaction_type" class="form-label">Type</label>
                <select id="transaction_type" name="transaction_type" class="form-select">
                    <option value="">All</option>
                    <option value="uncategorized" {% if filters.transaction_type == 'uncategorized' %}selected{% endif %}>Uncategorized</option>
                    <option value="income" {% if filters.transaction_type == 'income' %}selected{% endif %}>Income</option>
                    <option value="expense" {% if filters.transaction_type == 'expense' %}selected{% endif %}>Expense</option>
                    <option value="transfer" {% if filters.transaction_type == 'transfer' %}selected{% endif %}>Transfer</option>
                </select>
            </div>
            <div class="col-md-1">
                <button type="submit" class="btn btn-primary">Filter</button>
            </div>
        </div>
    </form>

    <form action="{{ url_for('bulk_actions') }}" method="post">
        <div class="mb-3 d-flex justify-content-between align-items-center">
            <div>
                <button type="submit" class="btn btn-info me-2" name="action" value="apply_rules" onclick="return confirm('Are you sure you want to apply rules to the selected entries?')">Apply Rules to Selected</button>
                <button type="submit" class="btn btn-primary me-2" name="action" value="update_type" onclick="return confirm('Are you sure you want to update the selected entries?')">Apply Type to Selected</button>
                <select id="bulk_transaction_type" name="transaction_type" class="form-select d-inline-block w-auto" required>
                    <option value="uncategorized">Uncategorized</option>
                    <option value="income">Income</option>
                    <option value="expense">Expense</option>
                    <option value="transfer">Transfer</option>
                </select>
                <button type="submit" class="btn btn-secondary ms-2" name="action" value="lock" onclick="return confirm('Are you sure you want to lock the selected entries?')">Lock Selected</button>
                <button type="submit" class="btn btn-secondary" name="action" value="unlock" onclick="return confirm('Are you sure you want to unlock the selected entries?')">Unlock Selected</button>
            </div>
            <button type="submit" class="btn btn-danger" name="action" value="delete" onclick="return confirm('Are you sure you want to delete the selected entries?')">Delete Selected</button>
        </div>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all"></th>
                    <th><a href="{{ url_for('journal', sort='date', direction='desc' if request.args.get('sort') == 'date' and request.args.get('direction') == 'asc' else 'asc') }}">Date</a></th>
                    <th><a href="{{ url_for('journal', sort='description', direction='desc' if request.args.get('sort') == 'description' and request.args.get('direction') == 'asc' else 'asc') }}">Description</a></th>
                    <th><a href="{{ url_for('journal', sort='account', direction='desc' if request.args.get('sort') == 'account' and request.args.get('direction') == 'asc' else 'asc') }}">Account</a></th>
                    <th><a href="{{ url_for('journal', sort='amount', direction='desc' if request.args.get('sort') == 'amount' and request.args.get('direction') == 'asc' else 'asc') }}">Amount</a></th>
                    <th><a href="{{ url_for('journal', sort='category', direction='desc' if request.args.get('sort') == 'category' and request.args.get('direction') == 'asc' else 'asc') }}">Category</a></th>
                    <th><a href="{{ url_for('journal', sort='transaction_type', direction='desc' if request.args.get('sort') == 'transaction_type' and request.args.get('direction') == 'asc' else 'asc') }}">Type</a></th>
                    <th><a href="{{ url_for('journal', sort='notes', direction='desc' if request.args.get('sort') == 'notes' and request.args.get('direction') == 'asc' else 'asc') }}">Notes</a></th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in entries %}
                <tr>
                    <td><input type="checkbox" name="entry_ids" value="{{ entry.id }}" class="form-check-input"></td>
                    <td>{{ entry.date }}</td>
                    <td>{{ entry.description }}</td>
                    <td>{{ entry.account.name }}</td>
                    <td>{{ entry.amount }}</td>
                    <td>{{ entry.category }}</td>
                    <td>{{ entry.transaction_type }}</td>
                    <td>{{ entry.notes or '' }}</td>
                    <td>
                        <a href="{{ url_for('edit_entry', entry_id=entry.id) }}" class="btn btn-sm btn-primary">Edit</a>
                        <a href="{{ url_for('delete_entry', entry_id=entry.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this entry?')">Delete</a>
                        <a href="{{ url_for('toggle_lock', entry_id=entry.id) }}" class="btn btn-sm btn-secondary">
                            {% if entry.locked %}
                                <i class="fas fa-lock"></i>
                            {% else %}
                                <i class="fas fa-lock-open"></i>
                            {% endif %}
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </form>

    <h2 class="mt-5">Add New Entry</h2>
    <form action="/add_entry" method="post" class="mt-3">
        <div class="row g-3">
            <div class="col-md-2">
                <label for="date" class="form-label">Date:</label>
                <input type="date" id="date" name="date" class="form-control" required>
            </div>
            <div class="col-md-3">
                <label for="description" class="form-label">Description:</label>
                <input type="text" id="description" name="description" class="form-control" required>
            </div>
            <div class="col-md-2">
                <label for="account" class="form-label">Account:</label>
                <select id="account" name="account" class="form-select" required>
                    {% for account in accounts %}
                    <option value="{{ account.id }}">{{ account.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-1">
                <label for="amount" class="form-label">Amount:</label>
                <input type="number" step="0.01" id="amount" name="amount" class="form-control" required>
            </div>
            <div class="col-md-2">
                <label for="category" class="form-label">Category:</label>
                <input type="text" id="category" name="category" class="form-control">
            </div>
            <div class="col-md-2">
                <label for="transaction_type" class="form-label">Type:</label>
                <select id="transaction_type" name="transaction_type" class="form-select" required>
                    <option value="uncategorized">Uncategorized</option>
                    <option value="income">Income</option>
                    <option value="expense">Expense</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="notes" class="form-label">Notes:</label>
                <input type="text" id="notes" name="notes" class="form-control">
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-success">Add Entry</button>
            </div>
        </div>
    </form>

    <script>
        document.getElementById('select-all').onclick = function() {
            var checkboxes = document.getElementsByName('entry_ids');
            for (var checkbox of checkboxes) {
                checkbox.checked = this.checked;
            }
        }
    </script>
{% endblock %}
