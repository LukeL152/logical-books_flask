{% extends "base.html" %}
{% from '_macros.html' import render_account_options %}

{% block content %}
    <h1 class="mb-4">Edit Rule</h1>

    <form action="{{ url_for('transactions.edit_transaction_rule', rule_id=rule.id) }}" method="post" class="mb-4 p-3 border rounded">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label for="name" class="form-label">Rule Name</label>
                <input type="text" id="name" name="name" class="form-control" value="{{ rule.name or '' }}" required>
            </div>
            <div class="col-md-3">
                <label for="keyword" class="form-label">Keyword (optional)</label>
                <input type="text" id="keyword" name="keyword" class="form-control" value="{{ rule.keyword or '' }}">
            </div>
            <div class="col-md-2">
                <label for="condition" class="form-label">Value Condition</label>
                <select id="condition" name="condition" class="form-select">
                    <option value="">None</option>
                    <option value="less_than" {% if rule.condition == 'less_than' %}selected{% endif %}>Less Than</option>
                    <option value="greater_than" {% if rule.condition == 'greater_than' %}selected{% endif %}>Greater Than</option>
                    <option value="equals" {% if rule.condition == 'equals' %}selected{% endif %}>Equals</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="value" class="form-label">Value</label>
                <input type="number" step="0.01" id="value" name="value" class="form-control" value="{{ rule.value or '' }}">
            </div>
            <div class="col-md-2">
                <label for="category" class="form-label">Category (optional)</label>
                <input type="text" id="category" name="category" class="form-control" value="{{ rule.category or '' }}">
            </div>
            <div class="col-md-3">
                <label for="debit_account_id" class="form-label">Debit Account (optional)</label>
                <select id="debit_account_id" name="debit_account_id" class="form-select">
                    <option value="">-- No Change --</option>
                    {{ render_account_options(accounts, selected_id=rule.debit_account_id) }}
                </select>
            </div>
            <div class="col-md-3">
                <label for="credit_account_id" class="form-label">Credit Account (optional)</label>
                <select id="credit_account_id" name="credit_account_id" class="form-select">
                    <option value="">-- No Change --</option>
                    {{ render_account_options(accounts, selected_id=rule.credit_account_id) }}
                </select>
            </div>
            <div class="col-md-2">
                <label for="transaction_type" class="form-label">Set Type (optional)</label>
                <select id="transaction_type" name="transaction_type" class="form-select">
                    <option value="">-- No Change --</option>
                    <option value="income" {% if rule.transaction_type == 'income' %}selected{% endif %}>Income</option>
                    <option value="expense" {% if rule.transaction_type == 'expense' %}selected{% endif %}>Expense</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="include_accounts" class="form-label">Include Accounts</label>
                <select id="include_accounts" name="include_accounts" class="form-select" multiple>
                    {{ render_account_options(accounts, selected_id=rule.accounts|selectattr('is_exclusion', 'equalto', false)|map(attribute='account_id')) }}
                </select>
            </div>
            <div class="col-md-2">
                <label for="exclude_accounts" class="form-label">Exclude Accounts</label>
                <select id="exclude_accounts" name="exclude_accounts" class="form-select" multiple>
                    {{ render_account_options(accounts, selected_id=rule.accounts|selectattr('is_exclusion', 'equalto', true)|map(attribute='account_id')) }}
                </select>
            </div>
            <div class="col-md-1">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="is_automatic" name="is_automatic" value="true" {% if rule.is_automatic %}checked{% endif %}>
                    <label class="form-check-label" for="is_automatic">Automatic</label>
                </div>
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary">Update Rule</button>
                <a href="{{ url_for('transactions.transaction_rules') }}" class="btn btn-secondary">Cancel</a>
            </div>
        </div>
    </form>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    $('#debit_account_id').select2();
    $('#credit_account_id').select2();
    $('#include_accounts').select2();
    $('#exclude_accounts').select2();
});
</script>
{% endblock %}