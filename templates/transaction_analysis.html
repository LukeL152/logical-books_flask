{% extends 'base.html' %}
{% from '_macros.html' import render_account_options %}

{% block title %}Transaction Analysis - Logical Books{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Transaction Analysis</h2>
    <hr>
    <div class="row g-3">
        <div class="col-md-3">
            <label for="start_date" class="form-label">Start Date</label>
            <input type="date" id="start_date" name="start_date" class="form-control">
        </div>
        <div class="col-md-3">
            <label for="end_date" class="form-label">End Date</label>
            <input type="date" id="end_date" name="end_date" class="form-control">
        </div>
        <div class="col-md-3">
            <label for="group_by" class="form-label">Group By</label>
            <select id="group_by" name="group_by" class="form-select">
                <option value="category">Category</option>
                <option value="account">Account</option>
                <option value="vendor">Vendor</option>
                <option value="month">Month</option>
                <option value="quarter">Quarter</option>
                <option value="year">Year</option>
            </select>
        </div>
        <div class="col-md-3">
            <label for="account_id" class="form-label">Account</label>
            <select id="account_id" name="account_id" class="form-select" multiple>
                {{ render_account_options(accounts) }}
            </select>
        </div>
        <div class="col-md-3">
            <label for="vendor_id" class="form-label">Vendor</label>
            <select id="vendor_id" name="vendor_id" class="form-select" multiple>
                {% for vendor in vendors %}
                    <option value="{{ vendor.id }}">{{ vendor.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="display_as" class="form-label">Display As</label>
            <select id="display_as" name="display_as" class="form-select">
                <option value="table">Table</option>
                <option value="chart">Chart</option>
            </select>
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button id="run-analysis" class="btn btn-primary">Run Analysis</button>
        </div>
    </div>

    <h3 class="mt-5">Results</h3>
    <div id="results-container"></div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
$(document).ready(function() {
    $('#account_id').select2();
    $('#vendor_id').select2();

    let chart = null;

    $('#run-analysis').on('click', function() {
        const startDate = $('#start_date').val();
        const endDate = $('#end_date').val();
        const groupBy = $('#group_by').val();
        const accountIds = $('#account_id').val();
        const vendorIds = $('#vendor_id').val();
        const displayAs = $('#display_as').val();

        let url = `/api/transaction_analysis?start_date=${startDate}&end_date=${endDate}&group_by=${groupBy}`;
        if (accountIds.length > 0) {
            url += `&account_id=${accountIds.join('&')}`;
        }
        if (vendorIds.length > 0) {
            url += `&vendor_id=${vendorIds.join('&')}`;
        }

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const resultsContainer = $('#results-container');
                resultsContainer.empty();

                if (displayAs === 'table') {
                    const table = $('<table class="table table-striped"><thead><tr><th>Group</th><th>Total</th></tr></thead><tbody></tbody></table>');
                    const tableBody = table.find('tbody');
                    data.forEach(row => {
                        tableBody.append(`<tr><td>${row.group}</td><td>${row.total.toFixed(2)}</td></tr>`);
                    });
                    resultsContainer.append(table);
                } else if (displayAs === 'chart') {
                    if (chart) {
                        chart.destroy();
                    }
                    const canvas = $('<canvas id="analysis-chart"></canvas>');
                    resultsContainer.append(canvas);
                    const ctx = canvas[0].getContext('2d');
                    chart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.map(row => row.group),
                            datasets: [{
                                label: 'Total',
                                data: data.map(row => row.total),
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            });
    });
});
</script>
{% endblock %}
