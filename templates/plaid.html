{% extends "base.html" %}

{% block content %}
<h1 class="title">Bank Integrations</h1>

<div class="mb-4">
    <button id="link-account-button" class="button is-primary">Link New Bank Account</button>
</div>

<h2 class="subtitle">Generate Hosted Link</h2>
<div class="mb-4">
    <div class="field">
        <button id="generate-hosted-link-button" class="button is-info" data-client-id="{{ client.id }}">Generate Hosted Link for {{ client.business_name }}</button>
    </div>
    <div class="field mt-2" id="hosted-link-display" style="display: none;">
        <label class="label">Hosted Link URL:</label>
        <div class="field has-addons">
            <div class="control is-expanded">
                <input class="input" type="text" id="generated-hosted-link-url" readonly>
            </div>
            <div class="control">
                <button class="button" id="copy-hosted-link-button">Copy</button>
            </div>
        </div>
        <p class="help">Copy this link and send it to your client.</p>
    </div>
</div>



<h2 class="subtitle">Linked Accounts</h2>
<table class="table is-fullwidth">
    <thead>
        <tr>
            <th>Institution</th>
            <th>Account Name</th>
            <th>Mask</th>
            <th>Subtype</th>
            <th>Balance</th>
            <th>Linked Local Account</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        {% for item in plaid_items %}
            <tr>
                <td colspan="7">
                    <strong>{{ item.institution_name }}</strong>
                    <button class="button is-small is-link add-account-button" data-plaid-item-id="{{ item.id }}">Add Account</button>
                    <button class="button is-small is-info refresh-balances-button" data-plaid-item-id="{{ item.id }}">Refresh Balances</button>
                    <button class="button is-small is-warning sync-accounts-button" data-plaid-item-id="{{ item.id }}">Sync Accounts</button>
                    <button class="button is-small is-danger delete-item-button" data-plaid-item-id="{{ item.id }}">Delete Institution</button>
                    <div class="mt-4">
                        <form class="fetch-transactions-form" data-plaid-item-id="{{ item.id }}">
                            <div class="field is-grouped">
                                <div class="control">
                                    <input class="input" type="date" name="start_date" required>
                                </div>
                                <div class="control">
                                    <input class="input" type="date" name="end_date" required>
                                </div>
                                <div class="control">
                                    <button class="button is-info">Fetch by Date</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </td>
            </tr>
            {% for plaid_account in item.plaid_accounts %}
            <tr>
                <td></td>
                <td>{{ plaid_account.name }}</td>
                <td>{{ plaid_account.mask }}</td>
                <td>{{ plaid_account.subtype }}</td>
                <td>
                    {% if plaid_account.local_account and plaid_account.local_account.current_balance is not none %}
                        {{ plaid_account.local_account.current_balance | round(2) }} as of {{ plaid_account.local_account.balance_last_updated.strftime('%Y-%m-%d %H:%M') if plaid_account.local_account.balance_last_updated else 'N/A' }}
                    {% else %}
                        N/A
                    {% endif %}
                </td>
                <td>
                    <div class="select">
                        <select class="account-select" data-plaid-account-id="{{ plaid_account.id }}">
                            <option value="">Select an account</option>
                            {% for account in accounts %}
                            <option value="{{ account.id }}" {% if plaid_account.local_account_id == account.id %}selected{% endif %}>{{ account.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </td>
                <td>
                    <button class="button is-info is-small sync-button" data-plaid-account-id="{{ plaid_account.id }}">Sync Transactions</button>
                    <button class="button is-success is-small save-account-button" data-plaid-account-id="{{ plaid_account.id }}">Save</button>
                    <button class="button is-danger is-small delete-account-button" data-plaid-account-id="{{ plaid_account.id }}">Delete Account</button>
                    <div class="mt-4">
                        <form class="fetch-transactions-form-account" data-plaid-account-id="{{ plaid_account.id }}">
                            <div class="field is-grouped">
                                <div class="control">
                                    <input class="input" type="date" name="start_date" required>
                                </div>
                                <div class="control">
                                    <input class="input" type="date" name="end_date" required>
                                </div>
                                <div class="control">
                                    <button class="button is-info">Fetch by Date</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        {% else %}
        <tr>
            <td colspan="6">No bank accounts linked yet.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    console.log('DOMContentLoaded event fired.');
    const linkAccountButton = document.getElementById('link-account-button');

    linkAccountButton.addEventListener('click', async () => {
        console.log('Link New Bank Account button clicked.');
        const response = await fetch('/api/create_link_token', { method: 'POST' });
        console.log('Response from create_link_token:', response);
        const { link_token } = await response.json();
        console.log('Link token received:', link_token);

        const handler = Plaid.create({
            token: link_token,
            onSuccess: async (public_token, metadata) => {
                console.log('Plaid Link onSuccess callback fired.');
                const response = await fetch('/api/exchange_public_token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        public_token: public_token,
                        institution_name: metadata.institution.name,
                        institution_id: metadata.institution.institution_id
                    }),
                });

                if (response.ok) {
                    location.reload();
                } else if (response.status === 409) {
                    const result = await response.json();
                    alert(result.error);
                } else {
                    alert('An unexpected error occurred.');
                }
            },
        });
        handler.open();
    });

    const generateHostedLinkButton = document.getElementById('generate-hosted-link-button');
    const hostedLinkDisplay = document.getElementById('hosted-link-display');
    const generatedHostedLinkUrl = document.getElementById('generated-hosted-link-url');

    generateHostedLinkButton.addEventListener('click', async () => {
        const clientId = generateHostedLinkButton.dataset.clientId;
        const button = generateHostedLinkButton;

        button.classList.add('is-loading');
        try {
            const response = await fetch(`/api/generate_hosted_link/${clientId}`, { method: 'POST' });
            const result = await response.json();

            if (response.ok) {
                generatedHostedLinkUrl.value = result.hosted_link_url;
                hostedLinkDisplay.style.display = 'block';
            } else {
                alert(`Error generating Hosted Link: ${result.error_message || 'Unknown error'}`);
            }
        } catch (error) {
            console.error('Error generating Hosted Link:', error);
            alert('An unexpected error occurred while generating the Hosted Link.');
        } finally {
            button.classList.remove('is-loading');
        }
    });

    const copyHostedLinkButton = document.getElementById('copy-hosted-link-button');
    copyHostedLinkButton.addEventListener('click', () => {
        const hostedLinkUrl = document.getElementById('generated-hosted-link-url');
        hostedLinkUrl.select();
        document.execCommand('copy');
        alert('Link copied to clipboard!');
    });

    const addAccountButtons = document.querySelectorAll('.add-account-button');
    addAccountButtons.forEach(button => {
        button.addEventListener('click', async (event) => {
            const plaidItemId = event.target.dataset.plaidItemId;
            const response = await fetch('/api/create_link_token_for_update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ plaid_item_id: plaidItemId }),
            });
            const { link_token } = await response.json();

            const handler = Plaid.create({
                token: link_token,
                onSuccess: async (public_token, metadata) => {
                    const response = await fetch('/api/exchange_public_token', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            public_token: public_token,
                            institution_name: metadata.institution.name,
                            institution_id: metadata.institution.institution_id
                        }),
                    });
                    if (response.ok) {
                        const result = await response.json();
                        if (result.status === 'no_new_accounts') {
                            alert("No new accounts were added.");
                        } else {
                            location.reload();
                        }
                    } else {
                        alert('An unexpected error occurred.');
                    }
                },
            });
            handler.open();
        });
    });

    const syncButtons = document.querySelectorAll('.sync-button');
    syncButtons.forEach(button => {
        button.addEventListener('click', async (event) => {
            const plaidAccountId = event.target.dataset.plaidAccountId;
            const response = await fetch('/api/transactions/sync', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ plaid_account_id: plaidAccountId }),
            });
            const result = await response.json();
            if (result.status === 'success') {
                alert(`Successfully synced ${result.added} new transactions.`);
                location.reload();
            } else if (result.status === 'no_accounts') {
                alert("No accounts were found for this item. Please try linking the account again.");
            } else {
                alert(`Error syncing transactions: ${result.error}`);
            }
        });
    });

    const saveAccountButtons = document.querySelectorAll('.save-account-button');
    saveAccountButtons.forEach(button => {
        button.addEventListener('click', async (event) => {
            const plaidAccountId = event.target.dataset.plaidAccountId;
            const accountId = document.querySelector(`.account-select[data-plaid-account-id="${plaidAccountId}"]`).value;
            const response = await fetch('/api/plaid/set_account', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    plaid_account_id: plaidAccountId,
                    account_id: accountId
                }),
            });
            const result = await response.json();
            if (result.status === 'success') {
                alert('Account saved successfully.');
            } else {
                alert(`Error saving account: ${result.error}`);
            }
        });
    });

    const deleteItemButtons = document.querySelectorAll('.delete-item-button');
    deleteItemButtons.forEach(button => {
        button.addEventListener('click', async (event) => {
            if (!confirm('Are you sure you want to delete this entire institution connection? This action cannot be undone.')) {
                return;
            }
            const plaidItemId = event.target.dataset.plaidItemId;
            const response = await fetch('/api/plaid/delete_item', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ plaid_item_id: plaidItemId }),
            });
            const result = await response.json();
            if (result.status === 'success') {
                location.reload();
            } else {
                alert(`Error deleting item: ${result.error}`);
            }
        });
    });

    const deleteAccountButtons = document.querySelectorAll('.delete-account-button');
    deleteAccountButtons.forEach(button => {
        button.addEventListener('click', async (event) => {
            if (!confirm('Are you sure you want to delete this account connection?')) {
                return;
            }
            const plaidAccountId = event.target.dataset.plaidAccountId;
            const response = await fetch('/api/plaid/delete_account', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ plaid_account_id: plaidAccountId }),
            });
            const result = await response.json();
            if (result.status === 'success') {
                location.reload();
            } else {
                alert(`Error deleting account: ${result.error}`);
            }
        });
    });

    const refreshBalancesButtons = document.querySelectorAll('.refresh-balances-button');
    refreshBalancesButtons.forEach(button => {
        button.addEventListener('click', async (event) => {
            const plaidItemId = event.target.dataset.plaidItemId;
            const response = await fetch('/api/plaid/refresh_balances', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ plaid_item_id: plaidItemId }),
            });
            const result = await response.json();
            if (result.status === 'success') {
                location.reload();
            } else {
                alert(`Error refreshing balances: ${result.error}`);
            }
        });
    });

    const syncAccountsButtons = document.querySelectorAll('.sync-accounts-button');
    syncAccountsButtons.forEach(button => {
        button.addEventListener('click', async (event) => {
            const plaidItemId = event.target.dataset.plaidItemId;
            const response = await fetch('/api/plaid/sync_accounts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ plaid_item_id: plaidItemId }),
            });
            const result = await response.json();
            if (result.status === 'success') {
                alert(`Successfully synced accounts. Added: ${result.added}, Deleted: ${result.deleted}.`);
                location.reload();
            } else {
                alert(`Error syncing accounts: ${result.error}`);
            }
        });
    });

    const fetchTransactionsForms = document.querySelectorAll('.fetch-transactions-form');
    fetchTransactionsForms.forEach(form => {
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const plaidItemId = form.dataset.plaidItemId;
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            data.plaid_item_id = plaidItemId;

            const response = await fetch('/api/plaid/fetch_transactions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });
            const result = await response.json();
            if (result.status === 'success') {
                alert(`Successfully fetched ${result.added} new transactions.`);
                location.reload();
            } else {
                alert(`Error fetching transactions: ${result.error}`);
            }
        });
    });

    const fetchTransactionsFormsAccount = document.querySelectorAll('.fetch-transactions-form-account');
    fetchTransactionsFormsAccount.forEach(form => {
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const plaidAccountId = form.dataset.plaidAccountId;
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            data.plaid_account_id = plaidAccountId;

            const response = await fetch('/api/plaid/fetch_transactions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });
            const result = await response.json();
            if (result.status === 'success') {
                alert(`Successfully fetched ${result.added} new transactions.`);
                location.reload();
            } else {
                alert(`Error fetching transactions: ${result.error}`);
            }
        });
    });
});
</script>
{% endblock %}