{% extends "base.html" %}

{% block content %}
<h1 class="mb-4">Analysis</h1>

<form method="POST" action="{{ url_for('analysis') }}" class="mb-4">
    <div class="row">
        <div class="col-md-6">
            <h5>Period 1</h5>
            <div class="input-group">
                <input type="date" name="start_date_1" class="form-control" value="{{ start_date_1 }}">
                <span class="input-group-text">to</span>
                <input type="date" name="end_date_1" class="form-control" value="{{ end_date_1 }}">
            </div>
        </div>
        <div class="col-md-6">
            <h5>Period 2</h5>
            <div class="input-group">
                <input type="date" name="start_date_2" class="form-control" value="{{ start_date_2 }}">
                <span class="input-group-text">to</span>
                <input type="date" name="end_date_2" class="form-control" value="{{ end_date_2 }}">
            </div>
        </div>
    </div>
    <button type="submit" class="btn btn-primary mt-3">Compare</button>
</form>

<ul class="nav nav-tabs" id="analysisTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="spending-by-category-tab" data-bs-toggle="tab" data-bs-target="#spending-by-category" type="button" role="tab" aria-controls="spending-by-category" aria-selected="true">Spending by Category</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="category-comparison-tab" data-bs-toggle="tab" data-bs-target="#category-comparison" type="button" role="tab" aria-controls="category-comparison" aria-selected="false">Category Comparison</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="income-vs-expense-tab" data-bs-toggle="tab" data-bs-target="#income-vs-expense" type="button" role="tab" aria-controls="income-vs-expense" aria-selected="false">Income vs. Expense</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="cash-flow-tab" data-bs-toggle="tab" data-bs-target="#cash-flow" type="button" role="tab" aria-controls="cash-flow" aria-selected="false">Cash Flow</button>
    </li>
</ul>

<div class="tab-content" id="analysisTabContent">
    <div class="tab-pane fade show active" id="spending-by-category" role="tabpanel" aria-labelledby="spending-by-category-tab">
        <h2 class="mt-4">Spending by Category (Period 1)</h2>
        <div class="row">
            <div class="col-md-6">
                <canvas id="categoryPieChart"></canvas>
            </div>
            <div class="col-md-6">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th class="text-end">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in spending_by_category %}
                        <tr>
                            <td><a href="{{ url_for('category_transactions', category_name=item[0]) }}">{{ item[0] }}</a></td>
                            <td class="text-end">{{ "%.2f"|format(item[1]) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="tab-pane fade" id="category-comparison" role="tabpanel" aria-labelledby="category-comparison-tab">
        <h2 class="mt-4">Category Comparison</h2>
        <canvas id="categoryComparisonChart"></canvas>
    </div>
    <div class="tab-pane fade" id="income-vs-expense" role="tabpanel" aria-labelledby="income-vs-expense-tab">
        <h2 class="mt-4">Income vs. Expense</h2>
        <canvas id="incomeExpenseLineChart"></canvas>
    </div>
    <div class="tab-pane fade" id="cash-flow" role="tabpanel" aria-labelledby="cash-flow-tab">
        <h2 class="mt-4">Cash Flow Statement</h2>
        <table class="table">
            <tbody>
                <tr>
                    <th colspan="2">Cash Flow from Operating Activities</th>
                </tr>
                <tr>
                    <td>Net Income</td>
                    <td class="text-end">{{ "%.2f"|format(net_income) }}</td>
                </tr>
                <tr>
                    <td>Depreciation</td>
                    <td class="text-end">{{ "%.2f"|format(depreciation) }}</td>
                </tr>
                <tr>
                    <td>Change in Accounts Receivable</td>
                    <td class="text-end">{{ "%.2f"|format(change_in_accounts_receivable) }}</td>
                </tr>
                <tr>
                    <td>Change in Inventory</td>
                    <td class="text-end">{{ "%.2f"|format(change_in_inventory) }}</td>
                </tr>
                <tr>
                    <td>Change in Accounts Payable</td>
                    <td class="text-end">{{ "%.2f"|format(change_in_accounts_payable) }}</td>
                </tr>
                <tr class="table-group-divider">
                    <th>Net Cash from Operating Activities</th>
                    <th class="text-end">{{ "%.2f"|format(net_cash_from_operating_activities) }}</th>
                </tr>
                <tr>
                    <th colspan="2">Cash Flow from Investing Activities</th>
                </tr>
                <tr>
                    <td>Purchase of Fixed Assets</td>
                    <td class="text-end">{{ "%.2f"|format(purchase_of_fixed_assets) }}</td>
                </tr>
                <tr class="table-group-divider">
                    <th>Net Cash from Investing Activities</th>
                    <th class="text-end">{{ "%.2f"|format(net_cash_from_investing_activities) }}</th>
                </tr>
                <tr>
                    <th colspan="2">Cash Flow from Financing Activities</th>
                </tr>
                <tr>
                    <td>Issuance of Long-Term Debt</td>
                    <td class="text-end">{{ "%.2f"|format(issuance_of_long_term_debt) }}</td>
                </tr>
                <tr>
                    <td>Repayment of Long-Term Debt</td>
                    <td class="text-end">{{ "%.2f"|format(repayment_of_long_term_debt) }}</td>
                </tr>
                <tr class="table-group-divider">
                    <th>Net Cash from Financing Activities</th>
                    <th class="text-end">{{ "%.2f"|format(net_cash_from_financing_activities) }}</th>
                </tr>
                <tr>
                    <th>Net Increase in Cash</th>
                    <th class="text-end">{{ "%.2f"|format(net_increase_in_cash) }}</th>
                </tr>
                <tr>
                    <td>Cash at Beginning of Period</td>
                    <td class="text-end">{{ "%.2f"|format(cash_at_beginning_of_period) }}</td>
                </tr>
                <tr class="table-group-divider">
                    <th>Cash at End of Period</th>
                    <th class="text-end">{{ "%.2f"|format(cash_at_end_of_period) }}</th>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Pie Chart for Spending by Category
    var pieCtx = document.getElementById('categoryPieChart').getContext('2d');
    var pieChart = new Chart(pieCtx, {
        type: 'pie',
        data: {
            labels: {{ category_labels|safe }},
            datasets: [{
                data: {{ category_data|safe }},
                backgroundColor: [
                    'rgba(255, 99, 132, 0.2)',
                    'rgba(54, 162, 235, 0.2)',
                    'rgba(255, 206, 86, 0.2)',
                    'rgba(75, 192, 192, 0.2)',
                    'rgba(153, 102, 255, 0.2)',
                    'rgba(255, 159, 64, 0.2)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            onClick: function (evt, activeElements) {
                if (activeElements && activeElements.length > 0) {
                    var category = this.data.labels[activeElements[0].index];
                    window.location.href = '/category_transactions/' + encodeURIComponent(category);
                }
            }
        }
    });

    // Bar Chart for Category Comparison
    var categoryComparisonCtx = document.getElementById('categoryComparisonChart').getContext('2d');
    var categoryComparisonChart = new Chart(categoryComparisonCtx, {
        type: 'bar',
        data: {
            labels: {{ category_comparison_labels|safe }},
            datasets: [
                {
                    label: 'Period 1',
                    data: {{ category_comparison_data_1|safe }},
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Period 2',
                    data: {{ category_comparison_data_2|safe }},
                    backgroundColor: 'rgba(255, 99, 132, 0.5)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Line Chart for Income vs. Expense
    var lineCtx = document.getElementById('incomeExpenseLineChart').getContext('2d');
    var lineChart = new Chart(lineCtx, {
        type: 'line',
        data: {
            labels: {{ all_months|tojson|safe }},
            datasets: [{
                label: 'Income',
                data: {{ income_trend_data|safe }},
                borderColor: 'rgba(75, 192, 192, 1)',
                tension: 0.1
            }, {
                label: 'Expense',
                data: {{ expense_trend_data|safe }},
                borderColor: 'rgba(255, 99, 132, 1)',
                tension: 0.1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
});
</script>
{% endblock %}