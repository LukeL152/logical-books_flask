{% extends 'base.html' %}
{% from '_macros.html' import render_account_options %}

{% block content %}
<h1 class="mb-4">Edit Transaction Rule</h1>

<form action="{{ url_for('transactions.edit_transaction_rule', rule_id=rule.id) }}" method="post" class="p-3 border rounded">
    <div class="row">
        <div class="col-md-6">
            <label for="source_account_id" class="form-label">Source Account</label>
            <select id="source_account_id" name="source_account_id" class="form-select">
                <option value="">All Accounts</option>
                {{ render_account_options(accounts, rule.source_account_id) }}
            </select>
        </div>
        <div class="col-md-6">
            <label for="keyword" class="form-label">Keyword</label>
            <input type="text" id="keyword" name="keyword" class="form-control" value="{{ rule.keyword or '' }}">
        </div>
    </div>

    <div class="row mt-3">
        <div class="col-md-6">
            <label for="category_condition" class="form-label">Category</label>
            <select id="category_condition" name="category_condition" class="form-select category-select-with-tags">
                <option value="">Any</option>
                {% for category in categories %}
                <option value="{{ category }}" {% if rule.category_condition == category %}selected{% endif %}>{{ category }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-6">
            <label for="transaction_type" class="form-label">Transaction Type</label>
            <select id="transaction_type" name="transaction_type" class="form-select">
                <option value="" {% if not rule.transaction_type %}selected{% endif %}>Any</option>
                <option value="debit" {% if rule.transaction_type == 'debit' %}selected{% endif %}>Debit</option>
                <option value="credit" {% if rule.transaction_type == 'credit' %}selected{% endif %}>Credit</option>
            </select>
        </div>
    </div>

    <div class="row mt-3">
        <div class="col-md-6">
            <label for="min_amount" class="form-label">Minimum Amount</label>
            <input type="number" step="0.01" id="min_amount" name="min_amount" class="form-control" value="{{ rule.min_amount if rule.min_amount is not none else '' }}">
        </div>
        <div class="col-md-6">
            <label for="max_amount" class="form-label">Maximum Amount</label>
            <input type="number" step="0.01" id="max_amount" name="max_amount" class="form-control" value="{{ rule.max_amount if rule.max_amount is not none else '' }}">
        </div>
    </div>

    <hr class="my-4">

    <h4 class="mb-3">Actions</h4>

    <div class="row">
        <div class="col-md-6">
            <label for="new_category" class="form-label">Set New Category</label>
            <select id="new_category" name="new_category" class="form-select category-select-with-tags">
                <option value="">Do Not Change</option>
                {% for category in categories %}
                <option value="{{ category }}" {% if rule.new_category == category %}selected{% endif %}>{{ category }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-6">
            <label for="new_description" class="form-label">Set New Description</label>
            <input type="text" id="new_description" name="new_description" class="form-control" value="{{ rule.new_description or '' }}">
        </div>
    </div>

    <div class="row mt-3">
        <div class="col-md-6">
            <label for="new_debit_account_id" class="form-label">Set Debit Account</label>
            <select id="new_debit_account_id" name="new_debit_account_id" class="form-select">
                <option value="">Do Not Change</option>
                {{ render_account_options(accounts, rule.new_debit_account_id) }}
            </select>
        </div>
        <div class="col-md-6">
            <label for="new_credit_account_id" class="form-label">Set Credit Account</label>
            <select id="new_credit_account_id" name="new_credit_account_id" class="form-select">
                <option value="">Do Not Change</option>
                {{ render_account_options(accounts, rule.new_credit_account_id) }}
            </select>
        </div>
    </div>

    <div class="row mt-3">
        <div class="col-md-6">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="is_automatic" name="is_automatic" value="1" {% if rule.is_automatic %}checked{% endif %}>
                <label class="form-check-label" for="is_automatic">
                    Apply Automatically
                </label>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="delete_transaction" name="delete_transaction" value="1" {% if rule.delete_transaction %}checked{% endif %}>
                <label class="form-check-label" for="delete_transaction">
                    Delete Transaction
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="flag_for_manual_assignment" name="flag_for_manual_assignment" value="1" {% if rule.flag_for_manual_assignment %}checked{% endif %}>
                <label class="form-check-label" for="flag_for_manual_assignment">
                    Flag for Manual Assignment
                </label>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <button type="submit" class="btn btn-primary">Save Changes</button>
        <a href="{{ url_for('transactions.transaction_rules') }}" class="btn btn-secondary">Cancel</a>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    $('#source_account_id').select2();
    $('#new_debit_account_id').select2();
    $('#new_credit_account_id').select2();
    $('.category-select-with-tags').select2({
        tags: true
    });
});
</script>
{% endblock %}
