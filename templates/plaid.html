{% extends "base.html" %}

{% block content %}
<h1 class="title">Bank Integrations</h1>

<div class="mb-4">
    <button id="link-account-button" class="button is-primary">Link New Bank Account</button>
</div>

<h2 class="subtitle">Linked Accounts</h2>
<table class="table is-fullwidth">
    <thead>
        <tr>
            <th>Institution</th>
            <th>Account Name</th>
            <th>Account Mask</th>
            <th>Account Type</th>
            <th>Source Account</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        {% for item in plaid_items %}
            {% for plaid_account in item.plaid_accounts %}
            <tr>
                <td>{{ item.institution_name }}</td>
                <td>{{ plaid_account.name }}</td>
                <td>{{ plaid_account.mask }}</td>
                <td>{{ plaid_account.subtype }}</td>
                <td>
                    <div class="select">
                        <select class="account-select" data-plaid-account-id="{{ plaid_account.id }}">
                            <option value="">Select an account</option>
                            {% for account in accounts %}
                            <option value="{{ account.id }}" {% if plaid_account.local_account_id == account.id %}selected{% endif %}>{{ account.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </td>
                <td>
                    <button class="button is-info is-small sync-button" data-plaid-account-id="{{ plaid_account.id }}">Sync Transactions</button>
                    <button class="button is-success is-small save-account-button" data-plaid-account-id="{{ plaid_account.id }}">Save</button>
                </td>
            </tr>
            {% endfor %}
        {% else %}
        <tr>
            <td colspan="6">No bank accounts linked yet.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const linkAccountButton = document.getElementById('link-account-button');

    linkAccountButton.addEventListener('click', async () => {
        const response = await fetch('/api/create_link_token', { method: 'POST' });
        const { link_token } = await response.json();

        const handler = Plaid.create({
            token: link_token,
            onSuccess: async (public_token, metadata) => {
                await fetch('/api/exchange_public_token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        public_token: public_token,
                        institution_name: metadata.institution.name
                    }),
                });
                location.reload();
            },
        });
        handler.open();
    });

    const syncButtons = document.querySelectorAll('.sync-button');
    syncButtons.forEach(button => {
        button.addEventListener('click', async (event) => {
            const plaidAccountId = event.target.dataset.plaidAccountId;
            const response = await fetch('/api/transactions/sync', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ plaid_account_id: plaidAccountId }),
            });
            const result = await response.json();
            if (result.status === 'success') {
                alert(`Successfully synced ${result.added} new transactions.`);
                location.reload();
            } else {
                alert(`Error syncing transactions: ${result.error}`);
            }
        });
    });

    const saveAccountButtons = document.querySelectorAll('.save-account-button');
    saveAccountButtons.forEach(button => {
        button.addEventListener('click', async (event) => {
            const plaidAccountId = event.target.dataset.plaidAccountId;
            const accountId = document.querySelector(`.account-select[data-plaid-account-id="${plaidAccountId}"]`).value;
            const response = await fetch('/api/plaid/set_account', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    plaid_account_id: plaidAccountId,
                    account_id: accountId
                }),
            });
            const result = await response.json();
            if (result.status === 'success') {
                alert('Account saved successfully.');
            } else {
                alert(`Error saving account: ${result.error}`);
            }
        });
    });
});
</script>
{% endblock %}